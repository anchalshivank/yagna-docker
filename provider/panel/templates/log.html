<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Latest compiled and minified CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <!-- Optional theme -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
            crossorigin="anonymous"></script>
    <title>Command panel</title>
</head>

<body>

<div id="module_list"></div>
<div> <button class="btn btn-primary" onclick="downloadLog();">Download filtered log</button> </div>
<div id="log_viewer" style="padding: 1em;">
</div>
</body>
<style>
    {% include 'log.css' %}
</style>
<script>
    // extract last folder
    let baseUrl = window.location.href.split('/').slice(0, -2).join('/');

    let logStorage = null;

    function downloadLog() {
        let exported = logStorage.exportDisplayedToLog();
        let blob = new Blob([exported], {type: "text/plain;charset=utf-8"});
        let url = URL.createObjectURL(blob);
        let a = document.createElement('a');
        a.href = url;
        a.download = 'filtered.log';  // The file name you want to save as
        document.body.appendChild(a);  // Append the anchor to the body
        a.click();  // Programmatically click the anchor to trigger the download
        document.body.removeChild(a);  // Remove the anchor from the document
        URL.revokeObjectURL(url);

    }
    async function showNodeFile(no, path) {
        let runUp = fetch(`${baseUrl}/yagna/${no}/file/${path}`, {
            method: "GET"
        });
        let response = await runUp;
        let resp = await response.text();

        let logFile = new LogFile(resp)

        logStorage.addLogFile(logFile);
        let displayFilter = new AcceptLogFilter();
        displayFilter.acceptedLogLevels = [];
        displayFilter.acceptedModules = [];
        displayFilter.contentSearchFields = [];
        const queryString = window.location.search;
        const urlParams = new URLSearchParams(queryString);
        if (urlParams.has('module') && urlParams.get('module') !== '') {
            displayFilter.acceptedModules = urlParams.get('module').split(',');
        }
        if (urlParams.has('level') && urlParams.get('level') !== '') {
            displayFilter.acceptedLogLevels = urlParams.get('level').split(',');
        }
        if (urlParams.has('search') && urlParams.get('search') !== '') {
            displayFilter.contentSearchFields = urlParams.get('search').split(',');
        }
        logStorage.setDisplayFilter(
            displayFilter
        );
        let displayDenyFilter = new DenyLogFilter();

        if (urlParams.has('deny_module') && urlParams.get('deny_module') !== '') {
            displayDenyFilter.deniedModules = urlParams.get('deny_module').split(',');
        }
        if (urlParams.has('deny_level') && urlParams.get('deny_level') !== '') {
            displayDenyFilter.deniedLogLevels = urlParams.get('deny_level').split(',');
        }
        if (urlParams.has('deny_search') && urlParams.get('deny_search') !== '') {
            displayDenyFilter.deniedSearchFields = urlParams.get('deny_search').split(',');
        }
        logStorage.setDisplayDenyFilter(
            displayDenyFilter
        );

        if (!urlParams.has('hide_modules') || urlParams.get('hide_modules') !== 'true') {
            $('#module_list').html(logStorage.renderModules());
        }

        $('#log_viewer').html(logStorage.renderLogEntries());
    }

    $(document).ready(function () {
        logStorage = new LogStorage();
        showNodeFile(0, 'yagna|yagna_rCURRENT.log')
    });


    {% include 'log.js' %}

</script>